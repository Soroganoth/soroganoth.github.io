<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<<<<<<< HEAD:post/Research/multi_tenant_applications_security/index.html
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Dive into Azure multi-tenant applications security | Soroganoth</title>
<meta name="keywords" content="Azure Security, Azure AD Security, Service Principal">
<meta name="description" content="Deep dive into Azure AD application security.">
<meta name="author" content="">
<link rel="canonical" href="https://soroganoth.com/post/research/multi_tenant_applications_security/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://soroganoth.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://soroganoth.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://soroganoth.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://soroganoth.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://soroganoth.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Dive into Azure multi-tenant applications security" />
<meta property="og:description" content="Deep dive into Azure AD application security." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://soroganoth.com/post/research/multi_tenant_applications_security/" /><meta property="og:image" content="https://soroganoth.com/owo.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-02-11T20:24:31+01:00" />
<meta property="article:modified_time" content="2023-02-11T20:24:31+01:00" /><meta property="og:site_name" content="Soroganoth" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://soroganoth.com/owo.png"/>

<meta name="twitter:title" content="Dive into Azure multi-tenant applications security"/>
<meta name="twitter:description" content="Deep dive into Azure AD application security."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "All posts",
      "item": "https://soroganoth.com/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Long Posts",
      "item": "https://soroganoth.com/post/research/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Dive into Azure multi-tenant applications security",
      "item": "https://soroganoth.com/post/research/multi_tenant_applications_security/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Dive into Azure multi-tenant applications security",
  "name": "Dive into Azure multi-tenant applications security",
  "description": "Deep dive into Azure AD application security.",
  "keywords": [
    "Azure Security", "Azure AD Security", "Service Principal"
  ],
  "articleBody": "A look at the security of cross tenant applications in Azure AD The goal of this article is to dig deeper into some poorly document security aspects of Azure Active Directory Applications, particularly regarding multi tenant applications.\nThis is not a comprehensive guide about application and service principal security, but an overview of some interesting security properties which I find non-obvious and interesting.\nIf you are not familiar with the basic concepts of Applications and Service principals in Azure AD, I suggest starting with the documentation. https://learn.microsoft.com/en-us/azure/active-directory/develop/application-model\nThe very TLDR of this is that App Registrations are simply the definition of an app. When an app is created a service principal is also created with it. The Service Principal is the \"secureable object\" that actually holds permissions. Microsoft documentation will sometimes treat these as the same thing, which causes some confusion that is very pertinent for this post.\nSingle Tenant Perspective Getting basic info After creating a multi-tenant app we get some basic info about our sample application.\n1Get-AzADApplication -DisplayName \"Crosstenant-app\" 2DisplayName Id AppId 3----------- -- ----- 4Crosstenant-App 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1 fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb 5 6Get-AzADServicePrincipal -DisplayName \"Crosstenant-app\" | select Displayname, Appid, ID 7DisplayName AppId Id 8----------- ----- -- 9Crosstenant-App fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb 97510906-bf60-40ba-8111-9c136c4c7363 Note that while the AppId is the same, the IDs are not. This is because the application and its associated service principal are separate objects in Azure AD. The AppId functions as the username of the service principal. The fact that these two are different comes with some interesting distinctions which are not obvious, semi-hidden credentials are among them.\nNormally when you create credentials for an app, you go to app registrations in the Azure portal and register new creds under the Certificates \u0026 Secrets tab.\n1Get-AzADAppCredential -ObjectId 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1 2 3CustomKeyIdentifier DisplayName EndDateTime Hint KeyId SecretText StartDateTime 4------------------- ----------- ----------- ---- ----- ---------- ------------- 5 blogg-test 08/09/2023 16:52:51 EKx 8f77bed7-a8e0-400e-957c-be6de2ba3b21 02/10/2023 17:52:51 The objectid for this commandlet is the Id of the App registration.\nThis credential allows logging in as the service principal, including for cross tenant access. Note that this credential is used by the service principal, but is registered to the app registration itself. This is a relevant distincion because you can also register credentials for the service principal itself, not for application registration.\nThe potential dangers this presents for privilege escalation has been noted before.\nhttps://dirkjanm.io/azure-ad-privilege-escalation-application-admin/\nIt is not clear to me why Microsoft decided it should be possible to add credentials to these “hidden” service principals, or directly to service principals in general. I’m very curious about what usecase in which this makes sense. I have seen some first party Azure/Microsoft services do this for their own service principal, so from a detection standpoint there are some false positives.\nPrivilege escalation via Applications and service principals is a big topic that I won’t dive into in this post. However it is worth remembering that App Registrations and Service Principals are different objects, both of which can be assigned Owner roles.\nThis means that the “Owners” tab of an App Registration is not the same as the “Owners” tab of the Service Principal in Enterprise Applications. Owners are allowed to create credentials without having any of the Application Admin roles.\nOwners of the Service Principal can only create credentials of the Service Principal itself, not for the App registration, and vice versa.\nFor a single tenant perspective this is irrelevant as these credentials have the same permissions, but as we will see later, this does have some consequence in a multitenant setting.\nSemi-hidden credentials An important takeaway is that for any application that exists in App registrations in your Azure portal, there can exist credentials both for the App registration itself, and for the underlying service principal.\nIf the App registration is not from your tenant, but you are using a third-party app, then credentials can exist for any Service principal in the Enterprise applications tab in the portal(after dirk-jan's blog post some limitations have been applied to Micrsoft 1st party service principals).\nWhile the Application registration only lives in a single home tenant, the service principal is the “securable object” aka the thing that actually holds permissions. This means that for a globally unique Application, a different service principal exists in each tenant.\nThis is explained here: https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#relationship-between-application-objects-and-service-principals\nChecking for both types of credentials for the same apps shows while there is a set of credentials for the app registration, none (yet) exists for the service principal.\n1PS /home/soroganoth\u003e Get-AzADAppCredential -ObjectId 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1 2 3CustomKeyIdentifier DisplayName EndDateTime Hint KeyId SecretText StartDateTime 4------------------- ----------- ----------- ---- ----- ---------- ------------- 5 blogg-test 08/09/2023 16:52:51 EKx 8f77bed7-a8e0-400e-957c-be6de2ba3b21 02/10/2023 17:52:51 6 7PS /home/soroganoth\u003e Get-AzADServicePrincipalCredential -ObjectId 97510906-bf60-40ba-8111-9c136c4c7363 8PS /home/soroganoth\u003e The object id of Get-AzADServicePrincipalCredential is the id of the service principal\nThe Commandlet Get-AzADAppCredential checks for creds registered in the app registration, while the commandlet Get-AzADServicePrincipalCredential checks for creds on the service principal object itself.\nCreating creds for the service principal.\n1PS /home/soroganoth\u003e New-azadspcredential -ObjectId 97510906-bf60-40ba-8111-9c136c4c7363 | fl 2 3CustomKeyIdentifier : 4DisplayName : 5EndDateTime : 02/11/2025 13:28:47 6Hint : guv 7KeyId : daffb636-6774-48ff-bfc6-e276ae81c766 8SecretText : nosecretforu 9StartDateTime : 02/11/2023 13:28:47 10AdditionalProperties : {[@odata.context, https://graph.microsoft.com/v1.0/$metadata#microsoft.graph.passwordCredential]} We have now created credentials for the service principal itself, and not the application registration.\n1PS /home/soroganoth\u003e Get-AzADAppCredential -ObjectId 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1 2 3CustomKeyIdentifier DisplayName EndDateTime Hint KeyId SecretText StartDateTime 4------------------- ----------- ----------- ---- ----- ---------- ------------- 5 blogg-test 08/09/2023 16:52:51 EKx 8f77bed7-a8e0-400e-957c-be6de2ba3b21 02/10/2023 17:52:51 6 7PS /home/soroganoth\u003e Get-AzADServicePrincipalCredential -ObjectId 97510906-bf60-40ba-8111-9c136c4c7363 8 9CustomKeyIdentifier DisplayName EndDateTime Hint KeyId SecretText StartDateTime 10------------------- ----------- ----------- ---- ----- ---------- ------------- 11 02/11/2025 13:28:47 guv daffb636-6774-48ff-bfc6-e276ae81c766 02/11/2023 13:28:47 For the application in the portal, nothing has changed\nChecking the manifest only shows one set of credentials\n1{ 2// Removed for brevity 3\t\"keyCredentials\": [], 4\t\"name\": \"Crosstenant-App\", 5\t\"passwordCredentials\": [ 6\t{ 7\t\"customKeyIdentifier\": null, 8\t\"endDate\": \"2023-08-09T16:52:51.287Z\", 9\t\"keyId\": \"8f77bed7-a8e0-400e-957c-be6de2ba3b21\", 10\t\"startDate\": \"2023-02-10T17:52:51.287Z\", 11\t\"value\": null, 12\t\"createdOn\": \"2023-02-10T17:52:55.6424548Z\", 13\t\"hint\": \"EKx\", 14\t\"displayName\": \"blogg-test\" 15\t} 16\t], 17 18// Removed for brevity In the Enterprise Applications part of the Azure I have not found anywhere to display the credentials now registered for the service principal.\nThis means that while not exactly well hidden, the average Azure admin is not likely to stumble upon them.\nThis affords threat actors a persistence method which is probably not well understood by admins, SecOps and IR teams.\nKQL for the different operations Adding Credentials to an Application Registration\n1AuditLogs 2| where OperationName == \"Update application – Certificates and secrets management \" Note that there is a trailing whitespace here, without it this query fails. This is likely a bug and may change in the future.\nAdding credentials to the Service Principal (if this happens a lot in your tenant, I have questions)\n1AuditLogs 2| where OperationName == \"Add service principal credentials\" Adding owner for Service Principal\n1AuditLogs 2| where OperationName == \"Add owner to service principal\" Adding owner for App registration\n1AuditLogs 2| where OperationName == \"Add owner to application\" Checking access tokens JWTs\nDecoded JWT from App registration creds\n1{ 2 \"typ\": \"JWT\", 3 \"nonce\": \"D6m6_7pckByYBBqZ92pzGS0EllfMKcYkNmcJIqwiJNA\", 4 \"alg\": \"RS256\", 5 \"x5t\": \"-KI3Q9nNR7bRofxmeZoXqbHZGew\", 6 \"kid\": \"-KI3Q9nNR7bRofxmeZoXqbHZGew\" 7}.{ 8 \"aud\": \"https://graph.microsoft.com\", 9 \"iss\": \"https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/\", 10 \"iat\": 1676115525, 11 \"nbf\": 1676115525, 12 \"exp\": 1676119425, 13 \"aio\": \"E2ZgYNB/uLsy2PWn61v9PR1nH/sEAQA=\", 14 \"app_displayname\": \"Crosstenant-App\", 15 \"appid\": \"fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb\", 16 \"appidacr\": \"1\", 17 \"idp\": \"https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/\", 18 \"idtyp\": \"app\", 19 \"oid\": \"97510906-bf60-40ba-8111-9c136c4c7363\", 20 \"rh\": \"0.AU4ADzqFafkPuEKRcK1GNCNxRgMAAAAAAAAAwAAAAAAAAACDAAA.\", 21 \"roles\": [ 22 \"User.Read.All\" 23 ], 24 \"sub\": \"97510906-bf60-40ba-8111-9c136c4c7363\", 25 \"tenant_region_scope\": \"EU\", 26 \"tid\": \"69853a0f-0ff9-42b8-9170-ad4634237146\", 27 \"uti\": \"bpsBhnb0IEC0oYl0SLs0AA\", 28 \"ver\": \"1.0\", 29 \"wids\": [ 30 \"0997a1d0-0d1d-4acb-b408-d5ca73121e90\" 31 ], 32 \"xms_tcdt\": 1673029163, 33 \"xms_tdbr\": \"EU\" 34}.[Signature] Decoded JWT from Service Principal Creds\n1{ 2 \"typ\": \"JWT\", 3 \"nonce\": \"45spjjliy4a_3TLdkhnMTmhyU0mJ1aedRZH9dIDIDp4\", 4 \"alg\": \"RS256\", 5 \"x5t\": \"-KI3Q9nNR7bRofxmeZoXqbHZGew\", 6 \"kid\": \"-KI3Q9nNR7bRofxmeZoXqbHZGew\" 7}.{ 8 \"aud\": \"https://graph.microsoft.com\", 9 \"iss\": \"https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/\", 10 \"iat\": 1676122368, 11 \"nbf\": 1676122368, 12 \"exp\": 1676126268, 13 \"aio\": \"E2ZgYNBMnOfELl4ipNkUc/vW8f/PAQ==\", 14 \"app_displayname\": \"Crosstenant-App\", 15 \"appid\": \"fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb\", 16 \"appidacr\": \"1\", 17 \"idp\": \"https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/\", 18 \"idtyp\": \"app\", 19 \"oid\": \"97510906-bf60-40ba-8111-9c136c4c7363\", 20 \"rh\": \"0.AU4ADzqFafkPuEKRcK1GNCNxRgMAAAAAAAAAwAAAAAAAAACDAAA.\", 21 \"roles\": [ 22 \"User.Read.All\" 23 ], 24 \"sub\": \"97510906-bf60-40ba-8111-9c136c4c7363\", 25 \"tenant_region_scope\": \"EU\", 26 \"tid\": \"69853a0f-0ff9-42b8-9170-ad4634237146\", 27 \"uti\": \"hC0SUfHmk0qOqKDv-7ErAA\", 28 \"ver\": \"1.0\", 29 \"wids\": [ 30 \"0997a1d0-0d1d-4acb-b408-d5ca73121e90\" 31 ], 32 \"xms_tcdt\": 1673029163, 33 \"xms_tdbr\": \"EU\" 34}.[Signature] Diffing the access tokens shows no real difference beyond values you would expect to change. They seem to be functionally the same credentials, with the only real difference being that one of them is included in the manifest of the application.\nSingle tenant Logs As you would expect both sign ins show up in the logs with the same service principal ID, which makes sense as both credentials are using the same username.\nThe Credential key ID is different between the two sign-ins, as you would expect. Beyond that there does not seem to be any information to differentiate between the two types of credentials.\nMulti-tenant differences Having looked at the differences between Service Principals and App Registrations from a single tenant perspective, from a multi-tenant perspective start becoming real weird.\nIn this situation the \"Crosstenant-App\" we have been working with so far is registered in the home tenant, and is now being approved for access by a customer tenant.\nBasics of how an app knows which tenant its accessing Firstly, a cross-tenant application defines the tenant it is accessing by the URL it fetches an access token from\n1https://login.microsoftonline.com//oauth2/v2.0/token So different tenants require different access tokens. The client_id, or username is however the same across all tenants.\nIf you have created a cross-tenant app, an admin from a different tenant can approve this app into their tenant and grant access via the admin consent URL\n1https://login.microsoftonline.com/organizations/v2.0/adminconsent?client_id=\u0026scope=https://graph.microsoft.com/.default (there are a few different ways of creating a consent URL https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/grant-admin-consent?pivots=portal)\nThis creates a service principal in that tenant. An App Registration is not created as this exists only in the home tenant.\nRunning as the admin in the customer tenant we can now see a service principal with the same AppId (as this is globally unique in Azure), but a different Id.\n1PS /home/soroganoth\u003e Get-AzADServicePrincipal -displayName \"Crosstenant-app\" | select Displayname, Appid, ID 2 3DisplayName AppId Id 4----------- ----- -- 5Crosstenant-App fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb 190d3268-6f11-49e6-8c14-4da10c9cc0c6 Even though this is an app from a different tenant, we can still create credentials for this Service Principal in our customer tenant. This is pretty weird behaviour which should probably be a detection usecase for SecOps teams.\n1PS /home/soroganoth\u003e new-azadspcredential -ObjectId 190d3268-6f11-49e6-8c14-4da10c9cc0c6 | fl 2 3CustomKeyIdentifier : 4DisplayName : 5EndDateTime : 02/11/2025 17:29:08 6Hint : 3Wi 7KeyId : 67135e6e-e725-4950-9a00-63d6dcbf8b79 8SecretText : nosecretforu 9StartDateTime : 02/11/2023 17:29:08 10AdditionalProperties : {[@odata.context, https://graph.microsoft.com/v1.0/$metadata#microsoft.graph.passwordCredential]} This allows us to get an access token to acts as this service principal in our own tenant (as the customer in this setting), with all its associated permissions.\nTrying to use this client to gain access to the home tenant will not work (we are still using the same AppId as the username in all of these logins, regardless of which tenant we are in).\nFrom the perspective of the home tenant, things are different depending on whether you are using the credentials from the app registration or the service principal.\nOnly the credentials from the app registration is included the in the manifest which is approved by customer admins, and only this credential can be used to access the customer tenant. Trying to get an access token to a customer tenant with the credentials registered directly to the service principal fails with an error of “invalid secret”.\nFor an attacker this means that creating creds for the service principal is useful for a single tenant scenario, but does not allow for supply-chain attacks to customer tenants.\nLogging surprise I was quite surprise to note that these logins from the credentials created in the customer tenant, was also logged in the home tenant.\nCustomer Tenant logs\nHome tenant logs\nNote identical Request and correlation ID.\nSurprisingly the home tenant can see the Service Principal ID, despite it existing in a customer tenant.\nSame Service Principal name, but with different IDs from different tenants\nThere are some interesting differences. The home tenant logs do not contain the Credential key ID field, while the customer tenant contains both Resource service principal ID and Credential key ID.\nThe Resource service principal ID is the local service principal for the resource, in this case it is the customer tenants Microsoft Graph Service Principal Id.\nLooking at the same logs in log analytics I can see that a TenantId is included. This does not seem to be connected to any of the tenants and it does not have an OIDC config in Azure at\nhttps://login.microsoftonline.com//v2.0/.well-known/openid-configuration\nHaving done some testing across different tenants and apps, the value seems to differ, but none of them seem to resolve to an actual TenantId.\nFrom a Managed Service Provider perspective these logs are limiting. I have not done any major testing, but the lack of a Credential key ID seems to be abnormal for Service Principal logins, and could be used to detect someone in a customer tenant logging in as your application (which should be a very rare anomaly), it does not actually tell you what tenant this is happening in. If you have only one app per customer, this is pretty simple.\nIf you have a multitenant App, there are things you can do. As the sign in logs in your tenant shows the service Principal ID, you can correlate that with the sub claim in the access token.\nCreate a script to get access token for each customer tenant and grab the sub claim from all the access tokens and map out which customer environments they belong to. This is very much a hack due poor logging on Microsofts part.\nSimple KQL to detect lacking Credential ID\n1AADServicePrincipalSignInLogs 2| where ServicePrincipalCredentialKeyId == \"\" Customer Permissions Escalation The owners and app admins of an App Registration can add permissions to an app without having the permission to consent for service principal to actually have these permissions.\nPermissions added but not consented\nHowever these permissions have now been included in the manifest, and if we send the admin consent URL to a customer admin again, they will be asked to give these permissions to the app.\nThis means that while the Owner of an application registration in Azure is not able to constent to the permissions in their own Azure tenant, they are indirectly able to do so in customer environments. This is non-obvious behaviour which service providers should take note of.\n",
  "wordCount" : "2401",
  "inLanguage": "en",
  "datePublished": "2023-02-11T20:24:31+01:00",
  "dateModified": "2023-02-11T20:24:31+01:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://soroganoth.com/post/research/multi_tenant_applications_security/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Soroganoth",
    "logo": {
      "@type": "ImageObject",
      "url": "https://soroganoth.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
=======
>>>>>>> 5cde6bc139b5398533ccf27806c418ccc358fac5:post/research/multi_tenant_applications_security/index.html

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://soroganoth.com/" accesskey="h" title="Soroganoth (Alt + H)">Soroganoth</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://soroganoth.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/post/research/" title="Deep dives">
                    <span>Deep dives</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/post/shorts/" title="Short posts">
                    <span>Short posts</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/about/abooutme" title="About me">
                    <span>About me</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/Soroganoth" title="Github">
                    <span>Github</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://twitter.com/soroganoth" title="Twitter">
                    <span>Twitter</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/tags/" title="Post Tags">
                    <span>Post Tags</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://soroganoth.com/">Home</a>&nbsp;»&nbsp;<a href="https://soroganoth.com/post/">All posts</a>&nbsp;»&nbsp;<a href="https://soroganoth.com/post/research/">Long Posts</a></div>
    <h1 class="post-title">
      Dive into Azure multi-tenant applications security
    </h1>
    <div class="post-description">
      Deep dive into Azure AD application security.
    </div>
    <div class="post-meta"><span title='2023-02-11 20:24:31 +0100 CET'>February 11, 2023</span>&nbsp;·&nbsp;12 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#a-look-at-the-security-of-cross-tenant-applications-in-azure-ad" aria-label="A look at the security of cross tenant applications in Azure AD">A look at the security of cross tenant applications in Azure AD</a><ul>
                        
                <li>
                    <a href="#single-tenant-perspective" aria-label="Single Tenant Perspective">Single Tenant Perspective</a><ul>
                        
                <li>
                    <a href="#getting-basic-info" aria-label="Getting basic info">Getting basic info</a></li>
                <li>
                    <a href="#semi-hidden-credentials" aria-label="Semi-hidden credentials">Semi-hidden credentials</a></li>
                <li>
                    <a href="#kql-for-the-different-operations" aria-label="KQL for the different operations">KQL for the different operations</a></li>
                <li>
                    <a href="#checking-access-tokens" aria-label="Checking access tokens">Checking access tokens</a></li>
                <li>
                    <a href="#single-tenant-logs" aria-label="Single tenant Logs">Single tenant Logs</a></li></ul>
                </li>
                <li>
                    <a href="#multi-tenant-differences" aria-label="Multi-tenant differences">Multi-tenant differences</a><ul>
                        
                <li>
                    <a href="#basics-of-how-an-app-knows-which-tenant-its-accessing" aria-label="Basics of how an app knows which tenant its accessing">Basics of how an app knows which tenant its accessing</a></li>
                <li>
                    <a href="#logging-surprise" aria-label="Logging surprise">Logging surprise</a></li>
                <li>
                    <a href="#customer-permissions-escalation" aria-label="Customer Permissions Escalation">Customer Permissions Escalation</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="a-look-at-the-security-of-cross-tenant-applications-in-azure-ad">A look at the security of cross tenant applications in Azure AD<a hidden class="anchor" aria-hidden="true" href="#a-look-at-the-security-of-cross-tenant-applications-in-azure-ad">#</a></h1>
<p><strong>The goal of this article is to dig deeper into some poorly document security aspects of Azure Active Directory Applications, particularly regarding multi tenant applications.</strong></p>
<p>This is not a comprehensive guide about application and service principal security, but an overview of some interesting security properties which I find non-obvious and interesting.</p>
<p>If you are not familiar with the basic concepts of Applications and Service principals in Azure AD, I suggest starting with the documentation. <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/application-model">https://learn.microsoft.com/en-us/azure/active-directory/develop/application-model</a></p>
<p>The very TLDR of this is that App Registrations are simply the definition of an app. When an app is created a service principal is also created with it. The Service Principal is the &quot;secureable object&quot; that actually holds permissions. Microsoft documentation will sometimes treat these as the same thing, which causes some confusion that is very pertinent for this post.</p>
<p> </p>
<h2 id="single-tenant-perspective">Single Tenant Perspective<a hidden class="anchor" aria-hidden="true" href="#single-tenant-perspective">#</a></h2>
<p> </p>
<h3 id="getting-basic-info">Getting basic info<a hidden class="anchor" aria-hidden="true" href="#getting-basic-info">#</a></h3>
<p>After creating a multi-tenant app we get some basic info about our sample application.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">Get-AzADApplication</span> <span class="n">-DisplayName</span> <span class="s2">&#34;Crosstenant-app&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">DisplayName</span>     <span class="n">Id</span>                                   <span class="n">AppId</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="p">-----------</span>     <span class="p">--</span>                                   <span class="p">-----</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="nb">Crosstenant-App</span> <span class="n">7bb7fbe2-c75f</span><span class="p">-</span><span class="mf">4372</span><span class="n">-a2e6-e3f2bfea38d1</span> <span class="n">fd518bbc</span><span class="p">-</span><span class="n">8b0d</span><span class="p">-</span><span class="n">48a0-afc3-d59ebdc5e9eb</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="nb">Get-AzADServicePrincipal</span> <span class="n">-DisplayName</span> <span class="s2">&#34;Crosstenant-app&#34;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Displayname</span><span class="p">,</span> <span class="n">Appid</span><span class="p">,</span> <span class="n">ID</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="n">DisplayName</span>     <span class="n">AppId</span>                                <span class="n">Id</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="p">-----------</span>     <span class="p">-----</span>                                <span class="p">--</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="nb">Crosstenant-App</span> <span class="n">fd518bbc</span><span class="p">-</span><span class="n">8b0d</span><span class="p">-</span><span class="n">48a0-afc3-d59ebdc5e9eb</span> <span class="mf">97510906</span><span class="n">-bf60</span><span class="p">-</span><span class="n">40ba</span><span class="p">-</span><span class="mf">8111</span><span class="p">-</span><span class="n">9c136c4c7363</span>
</span></span></code></pre></div><p>Note that while the AppId is the same, the IDs are not. This is because the application and its associated service principal are separate objects in Azure AD.
The AppId functions as the username of the service principal.
The fact that these two are different comes with some interesting distinctions which are not obvious, semi-hidden credentials are among them.</p>
<p>Normally when you create credentials for an app, you go to app registrations in the Azure portal and register new creds under the Certificates &amp; Secrets tab.</p>
<p><img loading="lazy" src="2.png" alt="Credentials showing up as you would expect"  />
</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">Get-AzADAppCredential -ObjectId 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl">CustomKeyIdentifier DisplayName EndDateTime         Hint KeyId                                SecretText StartDateTime
</span></span><span class="line"><span class="ln">4</span><span class="cl">------------------- ----------- -----------         ---- -----                                ---------- -------------
</span></span><span class="line"><span class="ln">5</span><span class="cl">                    blogg-test  08/09/2023 16:52:51 EKx  8f77bed7-a8e0-400e-957c-be6de2ba3b21            02/10/2023 17:52:51
</span></span></code></pre></div><p>The objectid for this commandlet is the Id of the App registration.</p>
<p>This credential allows logging in as the service principal, including for cross tenant access.
Note that this credential is used by the service principal, but is registered to the app registration itself. This is a relevant distincion because you can also register credentials for the service principal itself, not for application registration.</p>
<p>The potential dangers this presents for privilege escalation has been noted before.</p>
<p><a href="https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/">https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/</a></p>
<p>It is not clear to me why Microsoft decided it should be possible to add credentials to these “hidden” service principals, or directly to service principals in general. I’m very curious about what usecase in which this makes sense. I have seen some first party Azure/Microsoft services do this for their own service principal, so from a detection standpoint there are some false positives.</p>
<p>Privilege escalation via Applications and service principals is a big topic that I won’t dive into in this post. However it is worth remembering that App Registrations and Service Principals are different objects, both of which can be assigned Owner roles.</p>
<p>This means that the “Owners” tab of an App Registration is not the same as the “Owners” tab of the Service Principal in Enterprise Applications. Owners are allowed to create credentials without having any of the Application Admin roles.</p>
<p>Owners of the Service Principal can only create credentials of the Service Principal itself, not for the App registration, and vice versa.</p>
<p>For a single tenant perspective this is irrelevant as these credentials have the same permissions, but as we will see later, this does have some consequence in a multitenant setting.</p>
<p> </p>
<p> </p>
<h3 id="semi-hidden-credentials">Semi-hidden credentials<a hidden class="anchor" aria-hidden="true" href="#semi-hidden-credentials">#</a></h3>
<p>An important takeaway is that for any application that exists in <strong>App registrations</strong> in your Azure portal, there can exist credentials both for the App registration itself, and for the underlying service principal.</p>
<p>If the App registration is not from your tenant, but you are using a third-party app, then credentials can exist for any Service principal in the Enterprise applications tab in the portal(after dirk-jan's blog post some limitations have been applied to Micrsoft 1st party service principals).</p>
<p>While the Application registration only lives in a single home tenant, the service principal is the “securable object” aka the thing that actually holds permissions. This means that for a globally unique Application, a different service principal exists in each tenant.</p>
<p>This is explained here: <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#relationship-between-application-objects-and-service-principals">https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#relationship-between-application-objects-and-service-principals</a></p>
<p>Checking for both types of credentials for the same apps shows while there is a set of credentials for the app registration, none (yet) exists for the service principal.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">PS /home/soroganoth&gt; Get-AzADAppCredential -ObjectId 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl">CustomKeyIdentifier DisplayName EndDateTime         Hint KeyId                                SecretText StartDateTime
</span></span><span class="line"><span class="ln">4</span><span class="cl">------------------- ----------- -----------         ---- -----                                ---------- -------------
</span></span><span class="line"><span class="ln">5</span><span class="cl">                    blogg-test  08/09/2023 16:52:51 EKx  8f77bed7-a8e0-400e-957c-be6de2ba3b21            02/10/2023 17:52:51
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl">PS /home/soroganoth&gt; Get-AzADServicePrincipalCredential -ObjectId 97510906-bf60-40ba-8111-9c136c4c7363
</span></span><span class="line"><span class="ln">8</span><span class="cl">PS /home/soroganoth&gt;
</span></span></code></pre></div><p>The object id of Get-AzADServicePrincipalCredential is the id of the service principal</p>
<p>The Commandlet Get-AzADAppCredential checks for creds registered in the app registration, while the commandlet Get-AzADServicePrincipalCredential checks for creds on the service principal object itself.</p>
<p>Creating creds for the service principal.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">PS /home/soroganoth&gt; New-azadspcredential -ObjectId 97510906-bf60-40ba-8111-9c136c4c7363 | fl
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">CustomKeyIdentifier  :
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">DisplayName          :
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">EndDateTime          : 02/11/2025 13:28:47
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Hint                 : guv
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">KeyId                : daffb636-6774-48ff-bfc6-e276ae81c766
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">SecretText           : nosecretforu
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">StartDateTime        : 02/11/2023 13:28:47
</span></span><span class="line"><span class="ln">10</span><span class="cl">AdditionalProperties : {[@odata.context, https://graph.microsoft.com/v1.0/$metadata#microsoft.graph.passwordCredential]}
</span></span></code></pre></div><p>We have now created credentials for the service principal itself, and not the application registration.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">PS /home/soroganoth&gt; Get-AzADAppCredential -ObjectId 7bb7fbe2-c75f-4372-a2e6-e3f2bfea38d1
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">CustomKeyIdentifier DisplayName EndDateTime         Hint KeyId                                SecretText StartDateTime
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">------------------- ----------- -----------         ---- -----                                ---------- -------------
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">                    blogg-test  08/09/2023 16:52:51 EKx  8f77bed7-a8e0-400e-957c-be6de2ba3b21            02/10/2023 17:52:51
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">PS /home/soroganoth&gt; Get-AzADServicePrincipalCredential -ObjectId 97510906-bf60-40ba-8111-9c136c4c7363
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">CustomKeyIdentifier DisplayName EndDateTime         Hint KeyId                                SecretText StartDateTime
</span></span><span class="line"><span class="ln">10</span><span class="cl">------------------- ----------- -----------         ---- -----                                ---------- -------------
</span></span><span class="line"><span class="ln">11</span><span class="cl">                                02/11/2025 13:28:47 guv  daffb636-6774-48ff-bfc6-e276ae81c766            02/11/2023 13:28:47
</span></span></code></pre></div><p>For the application in the portal, nothing has changed</p>
<p><img loading="lazy" src="./7.png" alt="Still only old creds"  />
</p>
<p>Checking the manifest only shows one set of credentials</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1">// Removed for brevity
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>	<span class="nt">&#34;keyCredentials&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Crosstenant-App&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="nt">&#34;passwordCredentials&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">			<span class="nt">&#34;customKeyIdentifier&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">			<span class="nt">&#34;endDate&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-08-09T16:52:51.287Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">			<span class="nt">&#34;keyId&#34;</span><span class="p">:</span> <span class="s2">&#34;8f77bed7-a8e0-400e-957c-be6de2ba3b21&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">			<span class="nt">&#34;startDate&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-02-10T17:52:51.287Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">			<span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">			<span class="nt">&#34;createdOn&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-02-10T17:52:55.6424548Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">			<span class="nt">&#34;hint&#34;</span><span class="p">:</span> <span class="s2">&#34;EKx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">			<span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;blogg-test&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">	<span class="p">],</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1">// Removed for brevity
</span></span></span></code></pre></div><p>In the Enterprise Applications part of the Azure I have not found anywhere to display the credentials now registered for the service principal.</p>
<p>This means that while not exactly well hidden, the average Azure admin is not likely to stumble upon them.</p>
<p>This affords threat actors a persistence method which is probably not well understood by admins, SecOps and IR teams.</p>
<p> </p>
<p> </p>
<h3 id="kql-for-the-different-operations">KQL for the different operations<a hidden class="anchor" aria-hidden="true" href="#kql-for-the-different-operations">#</a></h3>
<p>Adding Credentials to an Application Registration</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">AuditLogs
</span></span><span class="line"><span class="ln">2</span><span class="cl">| where OperationName == &#34;Update application – Certificates and secrets management &#34;
</span></span></code></pre></div><p><strong>Note that there is a trailing whitespace here, without it this query fails.</strong>
This is likely a bug and may change in the future.</p>
<p> </p>
<p>Adding credentials to the Service Principal (if this happens a lot in your tenant, I have questions)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">AuditLogs 
</span></span><span class="line"><span class="ln">2</span><span class="cl">| where OperationName == &#34;Add service principal credentials&#34;
</span></span></code></pre></div><p> </p>
<p>Adding owner for Service Principal</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">AuditLogs
</span></span><span class="line"><span class="ln">2</span><span class="cl">| where OperationName == &#34;Add owner to service principal&#34;
</span></span></code></pre></div><p> </p>
<p>Adding owner for App registration</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">AuditLogs
</span></span><span class="line"><span class="ln">2</span><span class="cl">| where OperationName == &#34;Add owner to application&#34;
</span></span></code></pre></div><p> </p>
<p> </p>
<h3 id="checking-access-tokens">Checking access tokens<a hidden class="anchor" aria-hidden="true" href="#checking-access-tokens">#</a></h3>
<p>JWTs</p>
<p>Decoded JWT from App registration creds</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  <span class="nt">&#34;typ&#34;</span><span class="p">:</span> <span class="s2">&#34;JWT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  <span class="nt">&#34;nonce&#34;</span><span class="p">:</span> <span class="s2">&#34;D6m6_7pckByYBBqZ92pzGS0EllfMKcYkNmcJIqwiJNA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;RS256&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="nt">&#34;x5t&#34;</span><span class="p">:</span> <span class="s2">&#34;-KI3Q9nNR7bRofxmeZoXqbHZGew&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="nt">&#34;kid&#34;</span><span class="p">:</span> <span class="s2">&#34;-KI3Q9nNR7bRofxmeZoXqbHZGew&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">}</span><span class="err">.</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;https://graph.microsoft.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1676115525</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="nt">&#34;nbf&#34;</span><span class="p">:</span> <span class="mi">1676115525</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1676119425</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="nt">&#34;aio&#34;</span><span class="p">:</span> <span class="s2">&#34;E2ZgYNB/uLsy2PWn61v9PR1nH/sEAQA=&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="nt">&#34;app_displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Crosstenant-App&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="nt">&#34;appid&#34;</span><span class="p">:</span> <span class="s2">&#34;fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="nt">&#34;appidacr&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="nt">&#34;idp&#34;</span><span class="p">:</span> <span class="s2">&#34;https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="nt">&#34;idtyp&#34;</span><span class="p">:</span> <span class="s2">&#34;app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="nt">&#34;oid&#34;</span><span class="p">:</span> <span class="s2">&#34;97510906-bf60-40ba-8111-9c136c4c7363&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">  <span class="nt">&#34;rh&#34;</span><span class="p">:</span> <span class="s2">&#34;0.AU4ADzqFafkPuEKRcK1GNCNxRgMAAAAAAAAAwAAAAAAAAACDAAA.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">  <span class="nt">&#34;roles&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="s2">&#34;User.Read.All&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;97510906-bf60-40ba-8111-9c136c4c7363&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">  <span class="nt">&#34;tenant_region_scope&#34;</span><span class="p">:</span> <span class="s2">&#34;EU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">  <span class="nt">&#34;tid&#34;</span><span class="p">:</span> <span class="s2">&#34;69853a0f-0ff9-42b8-9170-ad4634237146&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  <span class="nt">&#34;uti&#34;</span><span class="p">:</span> <span class="s2">&#34;bpsBhnb0IEC0oYl0SLs0AA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="nt">&#34;ver&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="nt">&#34;wids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="s2">&#34;0997a1d0-0d1d-4acb-b408-d5ca73121e90&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">  <span class="nt">&#34;xms_tcdt&#34;</span><span class="p">:</span> <span class="mi">1673029163</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">  <span class="nt">&#34;xms_tdbr&#34;</span><span class="p">:</span> <span class="s2">&#34;EU&#34;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="p">}</span><span class="err">.</span><span class="p">[</span><span class="err">Signature</span><span class="p">]</span>
</span></span></code></pre></div><p>Decoded JWT from Service Principal Creds</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  <span class="nt">&#34;typ&#34;</span><span class="p">:</span> <span class="s2">&#34;JWT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  <span class="nt">&#34;nonce&#34;</span><span class="p">:</span> <span class="s2">&#34;45spjjliy4a_3TLdkhnMTmhyU0mJ1aedRZH9dIDIDp4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;RS256&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="nt">&#34;x5t&#34;</span><span class="p">:</span> <span class="s2">&#34;-KI3Q9nNR7bRofxmeZoXqbHZGew&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="nt">&#34;kid&#34;</span><span class="p">:</span> <span class="s2">&#34;-KI3Q9nNR7bRofxmeZoXqbHZGew&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">}</span><span class="err">.</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;https://graph.microsoft.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1676122368</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="nt">&#34;nbf&#34;</span><span class="p">:</span> <span class="mi">1676122368</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1676126268</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="nt">&#34;aio&#34;</span><span class="p">:</span> <span class="s2">&#34;E2ZgYNBMnOfELl4ipNkUc/vW8f/PAQ==&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="nt">&#34;app_displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;Crosstenant-App&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="nt">&#34;appid&#34;</span><span class="p">:</span> <span class="s2">&#34;fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="nt">&#34;appidacr&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="nt">&#34;idp&#34;</span><span class="p">:</span> <span class="s2">&#34;https://sts.windows.net/69853a0f-0ff9-42b8-9170-ad4634237146/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="nt">&#34;idtyp&#34;</span><span class="p">:</span> <span class="s2">&#34;app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="nt">&#34;oid&#34;</span><span class="p">:</span> <span class="s2">&#34;97510906-bf60-40ba-8111-9c136c4c7363&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">  <span class="nt">&#34;rh&#34;</span><span class="p">:</span> <span class="s2">&#34;0.AU4ADzqFafkPuEKRcK1GNCNxRgMAAAAAAAAAwAAAAAAAAACDAAA.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">  <span class="nt">&#34;roles&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="s2">&#34;User.Read.All&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;97510906-bf60-40ba-8111-9c136c4c7363&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">  <span class="nt">&#34;tenant_region_scope&#34;</span><span class="p">:</span> <span class="s2">&#34;EU&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">  <span class="nt">&#34;tid&#34;</span><span class="p">:</span> <span class="s2">&#34;69853a0f-0ff9-42b8-9170-ad4634237146&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  <span class="nt">&#34;uti&#34;</span><span class="p">:</span> <span class="s2">&#34;hC0SUfHmk0qOqKDv-7ErAA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="nt">&#34;ver&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="nt">&#34;wids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="s2">&#34;0997a1d0-0d1d-4acb-b408-d5ca73121e90&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">  <span class="nt">&#34;xms_tcdt&#34;</span><span class="p">:</span> <span class="mi">1673029163</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">  <span class="nt">&#34;xms_tdbr&#34;</span><span class="p">:</span> <span class="s2">&#34;EU&#34;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="p">}</span><span class="err">.</span><span class="p">[</span><span class="err">Signature</span><span class="p">]</span>
</span></span></code></pre></div><p>Diffing the access tokens shows no real difference beyond values you would expect to change. They seem to be functionally the same credentials, with the only real difference being that one of them is included in the manifest of the application.</p>
<p> </p>
<h3 id="single-tenant-logs">Single tenant Logs<a hidden class="anchor" aria-hidden="true" href="#single-tenant-logs">#</a></h3>
<p>As you would expect both sign ins show up in the logs with the same service principal ID, which makes sense as both credentials are using the same username.</p>
<p><img loading="lazy" src="./8.png" alt="Login from both SP creds and App Creds"  />
</p>
<p>The Credential key ID is different between the two sign-ins, as you would expect. Beyond that there does not seem to be any information to differentiate between the two types of credentials.</p>
<p> </p>
<h2 id="multi-tenant-differences">Multi-tenant differences<a hidden class="anchor" aria-hidden="true" href="#multi-tenant-differences">#</a></h2>
<p>Having looked at the differences between Service Principals and App Registrations from a single tenant perspective, from a multi-tenant perspective start becoming real weird.</p>
<p>In this situation the &quot;Crosstenant-App&quot; we have been working with so far is registered in the home tenant, and is now being approved for access by a customer tenant.</p>
<p> </p>
<h3 id="basics-of-how-an-app-knows-which-tenant-its-accessing">Basics of how an app knows which tenant its accessing<a hidden class="anchor" aria-hidden="true" href="#basics-of-how-an-app-knows-which-tenant-its-accessing">#</a></h3>
<p>Firstly, a cross-tenant application defines the tenant it is accessing by the URL it fetches an access token from</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">https://login.microsoftonline.com/&lt;tenantidhere&gt;/oauth2/v2.0/token
</span></span></code></pre></div><p>So different tenants require different access tokens. The client_id, or username is however the same across all tenants.</p>
<p>If you have created a cross-tenant app, an admin from a different tenant can approve this app into their tenant and grant access via the admin consent URL</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">https://login.microsoftonline.com/organizations/v2.0/adminconsent?client_id=&lt;your client id&gt;&amp;scope=https://graph.microsoft.com/.default
</span></span></code></pre></div><p>(there are a few different ways of creating a consent URL <a href="https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/grant-admin-consent?pivots=portal">https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/grant-admin-consent?pivots=portal</a>)</p>
<p>This creates a service principal in that tenant. An App Registration is not created as this exists only in the home tenant.</p>
<p>Running as the admin in the customer tenant we can now see a service principal with the same AppId (as this is globally unique in Azure), but a different Id.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">PS /home/soroganoth&gt; Get-AzADServicePrincipal -displayName &#34;Crosstenant-app&#34; | select Displayname, Appid, ID
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl">DisplayName     AppId                                Id
</span></span><span class="line"><span class="ln">4</span><span class="cl">-----------     -----                                --
</span></span><span class="line"><span class="ln">5</span><span class="cl">Crosstenant-App fd518bbc-8b0d-48a0-afc3-d59ebdc5e9eb 190d3268-6f11-49e6-8c14-4da10c9cc0c6
</span></span></code></pre></div><p>Even though this is an app from a different tenant, we can still create credentials for this Service Principal in our customer tenant. This is pretty weird behaviour which should probably be a detection usecase for SecOps teams.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln"> 1</span><span class="cl">PS /home/soroganoth&gt; new-azadspcredential -ObjectId 190d3268-6f11-49e6-8c14-4da10c9cc0c6 | fl
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">CustomKeyIdentifier  :
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">DisplayName          :
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">EndDateTime          : 02/11/2025 17:29:08
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Hint                 : 3Wi
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">KeyId                : 67135e6e-e725-4950-9a00-63d6dcbf8b79
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">SecretText           : nosecretforu
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">StartDateTime        : 02/11/2023 17:29:08
</span></span><span class="line"><span class="ln">10</span><span class="cl">AdditionalProperties : {[@odata.context, https://graph.microsoft.com/v1.0/$metadata#microsoft.graph.passwordCredential]}
</span></span></code></pre></div><p>This allows us to get an access token to acts as this service principal in our own tenant (as the customer in this setting), with all its associated permissions.</p>
<p>Trying to use this client to gain access to the home tenant will not work (we are still using the same AppId as the username in all of these logins, regardless of which tenant we are in).</p>
<p>From the perspective of the home tenant, things are different depending on whether you are using the credentials from the app registration or the service principal.</p>
<p>Only the credentials from the app registration is included the in the manifest which is approved by customer admins, and only this credential can be used to access the customer tenant.
Trying to get an access token to a customer tenant with the credentials registered directly to the service principal fails with an error of “invalid secret”.</p>
<p>For an attacker this means that creating creds for the service principal is useful for a single tenant scenario, but does not allow for supply-chain attacks to customer tenants.</p>
<p> </p>
<h3 id="logging-surprise">Logging surprise<a hidden class="anchor" aria-hidden="true" href="#logging-surprise">#</a></h3>
<p>I was quite surprise to note that these logins from the credentials created in the customer tenant, was also logged in the home tenant.</p>
<p>Customer Tenant logs</p>
<p><img loading="lazy" src="./11.png" alt="Customer Logs"  />
</p>
<p>Home tenant logs</p>
<p><img loading="lazy" src="./12.png" alt="Home tenant logs"  />
</p>
<p>Note identical Request and correlation ID.</p>
<p>Surprisingly the home tenant can see the Service Principal ID, despite it existing in a customer tenant.</p>
<p><img loading="lazy" src="./13.png" alt="190d3 Service Principal does not exist in this tenant"  />
</p>
<p>Same Service Principal name, but with different IDs from different tenants</p>
<p>There are some interesting differences. The home tenant logs do not contain the Credential key ID field, while the customer tenant contains both Resource service principal ID and Credential key ID.</p>
<p>The Resource service principal ID is the local service principal for the resource, in this case it is the customer tenants Microsoft Graph Service Principal Id.</p>
<p>Looking at the same logs in log analytics I can see that a TenantId is included. This does not seem to be connected to any of the tenants and it does not have an OIDC config in Azure at</p>
<p><code>https://login.microsoftonline.com/&lt;tenantid&gt;/v2.0/.well-known/openid-configuration</code></p>
<p>Having done some testing across different tenants and apps, the value seems to differ, but none of them seem to resolve to an actual TenantId.</p>
<p>From a Managed Service Provider perspective these logs are limiting.  I have not done any major testing, but the lack of a Credential key ID seems to be abnormal for Service Principal logins, and could be used to detect someone in a customer tenant logging in as your application (which should be a very rare anomaly), it does not actually tell you what tenant this is happening in. If you have only one app per customer, this is pretty simple.</p>
<p>If you have a multitenant App, there are things you can do. As the sign in logs in your tenant shows the service Principal ID, you can correlate that with the sub claim in the access token.</p>
<p>Create a script to get access token for each customer tenant and grab the sub claim from all the access tokens and map out which customer environments they belong to. This is very much a hack due poor logging on Microsofts part.</p>
<p>Simple KQL to detect lacking Credential ID</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">AADServicePrincipalSignInLogs
</span></span><span class="line"><span class="ln">2</span><span class="cl">| where ServicePrincipalCredentialKeyId == &#34;&#34;
</span></span></code></pre></div><p> </p>
<h3 id="customer-permissions-escalation">Customer Permissions Escalation<a hidden class="anchor" aria-hidden="true" href="#customer-permissions-escalation">#</a></h3>
<p>The owners and app admins of an App Registration can add permissions to an app without having the permission to consent for service principal to actually have these permissions.</p>
<p>Permissions added but not consented</p>
<p><img loading="lazy" src="./14.png" alt="Permissions added but not consented to"  />
</p>
<p>However these permissions have now been included in the manifest, and if we send the admin consent URL to a customer admin again, they will be asked to give these permissions to the app.</p>
<p><img loading="lazy" src="./15.png" alt="Customer admin being asked for permissions not granted to the same app in home tenant"  />
</p>
<p>This means that while the Owner of an application registration in Azure is not able to constent to the permissions in their own Azure tenant, they are indirectly able to do so in customer environments. This is non-obvious behaviour which service providers should take note of.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://soroganoth.com/tags/azure-security/">Azure Security</a></li>
      <li><a href="https://soroganoth.com/tags/azure-ad-security/">Azure AD Security</a></li>
      <li><a href="https://soroganoth.com/tags/service-principal/">Service Principal</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://soroganoth.com/post/shorts/sentinel_bicep_watchlist/">
    <span class="title">Next »</span>
    <br>
    <span>Deploy Azure Sentinel Watchlists with Bicep</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Dive into Azure multi-tenant applications security on twitter"
        href="https://twitter.com/intent/tweet/?text=Dive%20into%20Azure%20multi-tenant%20applications%20security&amp;url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f&amp;hashtags=AzureSecurity%2cAzureADSecurity%2cServicePrincipal">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Dive into Azure multi-tenant applications security on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f&amp;title=Dive%20into%20Azure%20multi-tenant%20applications%20security&amp;summary=Dive%20into%20Azure%20multi-tenant%20applications%20security&amp;source=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Dive into Azure multi-tenant applications security on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f&title=Dive%20into%20Azure%20multi-tenant%20applications%20security">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Dive into Azure multi-tenant applications security on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Dive into Azure multi-tenant applications security on whatsapp"
        href="https://api.whatsapp.com/send?text=Dive%20into%20Azure%20multi-tenant%20applications%20security%20-%20https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Dive into Azure multi-tenant applications security on telegram"
        href="https://telegram.me/share/url?text=Dive%20into%20Azure%20multi-tenant%20applications%20security&amp;url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fmulti_tenant_applications_security%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://soroganoth.com/">Soroganoth</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
