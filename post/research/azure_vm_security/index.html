<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command | Soroganoth</title>
<meta name="keywords" content="Azure Security, Azure VM Security">
<meta name="description" content="Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command">
<meta name="author" content="soroganoth">
<link rel="canonical" href="https://soroganoth.com/post/research/azure_vm_security/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://soroganoth.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://soroganoth.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://soroganoth.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://soroganoth.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://soroganoth.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command" />
<meta property="og:description" content="Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://soroganoth.com/post/research/azure_vm_security/" /><meta property="og:image" content="https://soroganoth.com/owo.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-03-03T18:04:07+01:00" />
<meta property="article:modified_time" content="2023-03-03T18:04:07+01:00" /><meta property="og:site_name" content="Soroganoth" />


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://soroganoth.com/owo.png"/>

<meta name="twitter:title" content="Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command"/>
<meta name="twitter:description" content="Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://soroganoth.com/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Deep dives",
      "item": "https://soroganoth.com/post/research/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command",
      "item": "https://soroganoth.com/post/research/azure_vm_security/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command",
  "name": "Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command",
  "description": "Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command",
  "keywords": [
    "Azure Security", "Azure VM Security"
  ],
  "articleBody": "Introduction This is the first of a series where I will be exploring the ways a threat actor can move from the Azure Management plane, into the operating system level of Azure Virtual Machines. This series will be dealing with the security properties (and attacks) that exist specifically because this is an Azure VM. The normal security measures at the OS and network level are obviously still relevant, but is not something I will detail here.\nIn this first part we will be looking at the Run Command.\nWhy is this relevant? While the cloud is a lot more than just a place to run virtual machines on someone else's hardware, running av VM is a foundational use case og where most organizations will start as they move to the cloud.\nAs a part of that they may set up an network security architecture roughly like this example from Microsoft.\nhttps://learn.microsoft.com/en-us/azure/governance/blueprints/samples/azure-security-benchmark-foundation/\nWhile doing this properly is important, there is one aspect of this that seem to confuse people not used to the cloud: Namely the management plane.\nAll of the resources in this diagram are Azure resources which can be managed via an API. This API is accessible via the internet and you have no network level controls to protect these APIs.\nThis introduces two important takeaways which seems to be not be well understood by many:\nManagement traffic of your Azure Platform does not involve any network or IP addresses you control (although application og system specific management traffic may do so). Lateral movement in the cloud does not need to involve the network layer. While you can use IP and device based Conditional Access rules to force management access down into a network you control, and attackers can do lateral movement at the network layer, none of these are a given.\nNetwork security measures are critical for protecting workloads. But if I ask what you are doing to protect your Azure Management plane, and the answer is a network diagram, the complete lack of network controls for the management plane means that one is fundamentally missing the point.\nIf your idea of detecting lateral movement in a public cloud involves looking at network traffic, you are not wrong, but you are also going to be blind to a lot. While I have not found any comprehensive statistics of Azure attack methods(though I would love to), my impression based on available threat intel reports is that lateral movement in Azure is commonly done on the management/identity plane.\nFor this reason I will be going through some methods an attacker with the appropriate permissions in Azure can move from the management plane, down into the data plane of a virtual machine, and what can be done to defend against it.\nAll of these methods will allow an attacker to steal data or execute code on the machine. Most of these of these methods can not be detected at the network layer. Most can be detected via host level logging, and all can be logged and to some extent detected via Azure Activity Logs.\nThe Run Command The most well known of these methods which is the focus of this part of the series is the Run Command. Which is well documented already:\nhttps://www.mandiant.com/resources/blog/azure-run-command-dummies\nhttps://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-run-command/\nhttps://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/\nhttps://www.netspi.com/blog/technical/cloud-penetration-testing/running-powershell-scripts-on-azure-vms/\nhttps://posts.specterops.io/automating-azure-abuse-research-part-1-30b0eca33418\nhttps://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/investigating-suspicious-azure-activity-with-microsoft-sentinel/ba-p/2985699\nThe Run Command is a feature that lets you call the API to run a script on the VM as SYSTEM or Root.\nThis allows an attacker to do anything on the host. Stealing information, deploying beacons, stealing Accesstokens for the Managed Identity to do lateral movement.\nFunctionally there are two types of run commands. The default Custom Script Extension (now called Action Run Command), and the newer Managed Run Command https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed.\nThe newer Managed Run command has more advanced functionality such protected parameters and fetching scripts from a URI.\nArtifacts The Mandiant article about the run command details a lot of details about what happens at the OS level. Since then the newer Managed Run Command has been released, which has has different host artifacts.\nOld Action Run Command\nContains scripts at /var/lib/waagent/run-command/download Status/output of script at /var/lib/waagent//Microsoft.CPlat.Core.RunCommandLinux-1.0.5/status Full run logs /var/log/azure/run-command/handler.log Windows: C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\\\Status\\.status\nNew Managed Run Command\nContains scripts at /var/lib/waagent/run-command-handler/download Status/output of script at /var/lib/waagent/Microsoft.CPlat.Core.RunCommandHandlerLinux-1.3.2/status Full run logs /var/log/azure/run-command-handler/handler.log Windows: C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandHandlerWindows\\\\Status\\.status\nAs the Azure Activity Logs do not give any information about what was ran, these host artifacts are an important source of information, if there was no EDR or similar logging solution in place when the command was run.\nExample of a status output log doing echo \"rawrX3.\nIn the New Managed Run Command however, there is more information to collect.\nDocs for the Managed Run Command: https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed\nWe can create a command via Az CLI\naz vm run-command create --name \"mycustomRunCommand5\" --vm-name \"importantVM\" --resource-group \"VMSEC\" --script \"whoami\" We can then list the created commands az vm run-command list --vm-name \"importantVM\" --resource-group \"VMSEC\" The show command shows output of last execution in the \"output\" field.\nChanging the script to run the \"date\" command shows that it does not trigger an execution of the script when you create it again, and the az vm run-command invoke command seems to only be part of the old Run commands. I cannot find a way to run one of the Managed Run commands with it.\nThese changes are logged in the Azure Activity logs, but not what is changed. This means running\naz vm run-command create --name \"mycustomRunCommand5\" --vm-name \"importantVM\" --resource-group \"VMSEC\" --script \"whoami\"\nand then\naz vm run-command create --name \"mycustomRunCommand5\" --vm-name \"importantVM\" --resource-group \"VMSEC\" --script \"echo 'owo'\"\nWill only show the last \"echo 'owo'\" command, and not \"whoami\".\nFrom a forensics point of view you can then tell the last command that was run and its output, and correlate with the Azure Activity Logs to see if other scripts were run.\nForensics Evasion via Secure Parameters The documentation for Managed Run Command shows that you can now pass parameters in a secure manner https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed#create-or-update-run-command-on-a-vm-instance-using-parameter-and-protectedparameter-parameters-public-and-protected-parameters-to-script\nOne part caught my eye. These nameless params on linux seems like an easy place to place other commands in way that should evade some logging.\nCreating our secure params\n$ProtectedParametersArray = @([Microsoft.Azure.PowerShell.Cmdlets.Compute.Models.Api20210701.IRunCommandInputParameter]@{name='';value=';touch /owo69'})\nCreating command\nSet-AzVMRunCommand -ResourceGroupName VMSEC -VMName importantVM -RunCommandName SecretCommand -SourceScript \"hostname\" -ProtectedParameter $ProtectedParametersArray -Location EastUs\nI ended up doing this in the cloud shell as for some reason I could not create the parameters without error locally.\nprotectedParameters are shown as null, despite it very much being present.\nHaving run quite a few commands at this point there are a lot of file artifacts being dropped, but our secret command ran and created a file.\nLooking at the logs from the Run commands shows no sign of any secret param\nThis means that the secret params can be used to run any command via Managed Run Commands without generating any logs.\nWhich is not great.\nAzure Logs and KQL\nWRITE is for creating the extensions.\nThis gives information about who created a new run command script, but not what it contains.\nAzureActivity | where OperationNameValue == \"MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMANDS/WRITE\" Actually running the extensions are MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION\nThis will show that A Run command was run, but not which one.\nAzureActivity | where OperationNameValue == \"MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION\" While doing this testing I found out that this did not seem to be case.\nCreating a Managed Run Command also runs it, but this does not seem to show up in the logs as MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION OperationNameValue, only WRITE.\nI created a role with the notAction for MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION and only the MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMANDS/WRITE permission from MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMANDS\nIn theory, a user with only this role should only be able to write an Run Command, and not actually run it. Turns out, no.\nI reported this MSRC and they have now documented this behaviour https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed#limiting-access-to-run-command.\nThis means that any detection rules based on detecting use of the ACTION will not detect use of the Managed Run Command.\nDefense While the Run command is a useful feature it also has a very significant abuse potential for any compromised accounts with the right permissions. Unfortunately the feature itself cannot be turned off, so it must be dealt with by managing permissions.\nThe first step is least privilege. Are you using this feature for admin work? Does everyone with permissions to use the Run Command need them?\nIf you are not using this feature, create custom roles to administer VMs that do not contain these permissions.\nGenerally your VM admins should use the Virtual Machine Contributor role rather than Owner or Contributor roles. However, beware the documentation. If you look at this definition of the Virtual Machine Contributor, do you think that this role would be able to run commands on the VM?\nLogging in to the portal with Virtual Machine Contributor role on a machine. What about now? You would probably think no, but you would be wrong. It has the Microsoft.Compute/virtualMachines/* permissions, without associated notActions, and as such it can run commands.\nIn terms of Azure Security, be wary of what the Azure Portal says you cannot do, as it will lie to you. The API or Powershell is generally a better source of truth.\nThe docs do a better job at explaining what this role can actually do. https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-contributor\nCreating a managed Run Command from an account with only the Virtual Machine Contributor role.\nAnd our file shows up\nTo avoid this, we create a custom VM admin contributor role with notActions for the run command.\nYou can get this from my github.\nTemplate\nThis is a clone of the Virtual Machine Contributor role, with the only changes being the notActions for the run command permissions. It is scoped be deployed at the subscription level.\nSo now you have a role that can be used to do admin work, next step is enforcing that the normal Virtual Machine Contributor role is not used.\nEnter Azure Policy.\nMicrosoft has a boilerplate that be quickly modified to prevent using the role.\nhttps://github.com/Azure/azure-policy/blob/master/samples/Authorization/allowed-role-definitions/azurepolicy.json\nCustomizing to deny the Virtual Machine Contributor assignment.\n{ \"mode\": \"All\", \"policyRule\": { \"if\": { \"allOf\": [ { \"field\": \"type\", \"equals\": \"Microsoft.Authorization/roleAssignments\" }, { \"field\": \"Microsoft.Authorization/roleAssignments/roleDefinitionId\", \"equals\": \"/providers/Microsoft.Authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c\" } ] }, \"then\": { \"effect\": \"deny\" } }, \"parameters\": {} } https://github.com/Soroganoth/Blog-Templates-and-Scripts/blob/main/Azure_Policy/No_VM_Contributor_roles.json\nPaste this into the a new policy definition in the portal and deploy.\nThis will deny any attempts to assign the Virtual Machine Contributor role.\nEnd This is the first part of a planned series so stay tuned!\n",
  "wordCount" : "1740",
  "inLanguage": "en",
  "datePublished": "2023-03-03T18:04:07+01:00",
  "dateModified": "2023-03-03T18:04:07+01:00",
  "author":{
    "@type": "Person",
    "name": "soroganoth"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://soroganoth.com/post/research/azure_vm_security/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Soroganoth",
    "logo": {
      "@type": "ImageObject",
      "url": "https://soroganoth.com/favicon.ico"
    }
  }
}
</script><script defer data-domain="soroganoth.com" src="https://plausible.io/js/script.js"></script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://soroganoth.com/" accesskey="h" title="Soroganoth (Alt + H)">Soroganoth</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://soroganoth.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/post/research/" title="Deep dives">
                    <span>Deep dives</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/post/shorts/" title="Short posts">
                    <span>Short posts</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/about/abooutme" title="About me">
                    <span>About me</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/Soroganoth" title="Github">
                    <span>Github</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://twitter.com/soroganoth" title="Twitter">
                    <span>Twitter</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/tags/" title="Post Tags">
                    <span>Post Tags</span>
                </a>
            </li>
            <li>
                <a href="https://soroganoth.com/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://soroganoth.com/">Home</a>&nbsp;»&nbsp;<a href="https://soroganoth.com/post/">Posts</a>&nbsp;»&nbsp;<a href="https://soroganoth.com/post/research/">Deep dives</a></div>
    <h1 class="post-title">
      Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command
    </h1>
    <div class="post-description">
      Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command
    </div>
    <div class="post-meta"><span title='2023-03-03 18:04:07 +0100 CET'>March 3, 2023</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;soroganoth

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#why-is-this-relevant" aria-label="Why is this relevant?">Why is this relevant?</a></li>
                <li>
                    <a href="#the-run-command" aria-label="The Run Command">The Run Command</a><ul>
                        
                <li>
                    <a href="#artifacts" aria-label="Artifacts">Artifacts</a></li>
                <li>
                    <a href="#forensics-evasion-via-secure-parameters" aria-label="Forensics Evasion via Secure Parameters">Forensics Evasion via Secure Parameters</a></li></ul>
                </li>
                <li>
                    <a href="#defense" aria-label="Defense">Defense</a></li>
                <li>
                    <a href="#end" aria-label="End">End</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>This is the first of a series where I will be exploring the ways a threat actor can move from the Azure Management plane, into the operating system level of Azure Virtual Machines.
This series will be dealing with the security properties (and attacks) that exist specifically because this is an Azure VM. The normal security measures at the OS and network level are obviously still relevant, but is not something I will detail here.</p>
<p>In this first part we will be looking at the Run Command.</p>
<h2 id="why-is-this-relevant">Why is this relevant?<a hidden class="anchor" aria-hidden="true" href="#why-is-this-relevant">#</a></h2>
<p>While the cloud is a lot more than just a place to run virtual machines on someone else's hardware, running av VM is a foundational use case og where most organizations will start as they move to the cloud.</p>
<p>As a part of that they may set up an network security architecture roughly like this example from Microsoft.</p>
<p><img loading="lazy" src="./azure_network_architecture.png" alt="Example Network Security Architecture"  />
</p>
<p><a href="https://learn.microsoft.com/en-us/azure/governance/blueprints/samples/azure-security-benchmark-foundation/">https://learn.microsoft.com/en-us/azure/governance/blueprints/samples/azure-security-benchmark-foundation/</a></p>
<p>While doing this properly is important, there is one aspect of this that seem to confuse people not used to the cloud: Namely the management plane.</p>
<p>All of the resources in this diagram are Azure resources which can be managed via an API. This API is accessible via the internet and you have no network level controls to protect these APIs.</p>
<p>This introduces two important takeaways which seems to be not be well understood by many:</p>
<ul>
<li>Management traffic of your Azure Platform does not involve any network or IP addresses you control (although application og system specific management traffic may do so).</li>
<li>Lateral movement in the cloud does not need to involve the network layer.</li>
</ul>
<p>While you can use IP and device based Conditional Access rules to force management access down into a network you control, and attackers can do lateral movement at the network layer, none of these are a given.</p>
<p>Network security measures are critical for protecting workloads. But if I ask what you are doing to protect your Azure Management plane, and the answer is a network diagram, the complete lack of network controls for the management plane means that one is fundamentally missing the point.</p>
<p>If your idea of detecting lateral movement in a public cloud involves looking at network traffic, you are not wrong, but you are also going to be blind to a lot.
While I have not found any comprehensive statistics of Azure attack methods(though I would love to), my impression based on available threat intel reports is that lateral movement in Azure is commonly done on the management/identity plane.</p>
<p>For this reason I will be going through some methods an attacker with the appropriate permissions in Azure can move from the management plane, down into the data plane of a virtual machine, and what can be done to defend against it.</p>
<p>All of these methods will allow an attacker to steal data or execute code on the machine.
Most of these of these methods can not be detected at the network layer. Most can be detected via host level logging, and all can be logged and to some extent detected via Azure Activity Logs.</p>
<p> 
 </p>
<h2 id="the-run-command">The Run Command<a hidden class="anchor" aria-hidden="true" href="#the-run-command">#</a></h2>
<p>The most well known of these methods which is the focus of this part of the series is the Run Command. Which is well documented already:</p>
<p><a href="https://www.mandiant.com/resources/blog/azure-run-command-dummies">https://www.mandiant.com/resources/blog/azure-run-command-dummies</a></p>
<p><a href="https://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-run-command/">https://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-run-command/</a></p>
<p><a href="https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/">https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/</a></p>
<p><a href="https://www.netspi.com/blog/technical/cloud-penetration-testing/running-powershell-scripts-on-azure-vms/">https://www.netspi.com/blog/technical/cloud-penetration-testing/running-powershell-scripts-on-azure-vms/</a></p>
<p><a href="https://posts.specterops.io/automating-azure-abuse-research-part-1-30b0eca33418">https://posts.specterops.io/automating-azure-abuse-research-part-1-30b0eca33418</a></p>
<p><a href="https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/investigating-suspicious-azure-activity-with-microsoft-sentinel/ba-p/2985699">https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/investigating-suspicious-azure-activity-with-microsoft-sentinel/ba-p/2985699</a></p>
<p> </p>
<p>The Run Command is a feature that lets you call the API to run a script on the VM as SYSTEM or Root.</p>
<p>This allows an attacker to do anything on the host. Stealing information, deploying beacons, stealing Accesstokens for the Managed Identity to do lateral movement.</p>
<p>Functionally there are two types of run commands. The default Custom Script Extension (now called Action Run Command), and the newer Managed Run Command <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed">https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed</a>.</p>
<p>The newer Managed Run command has more advanced functionality such protected parameters and fetching scripts from a URI.</p>
<p> </p>
<p> </p>
<h3 id="artifacts">Artifacts<a hidden class="anchor" aria-hidden="true" href="#artifacts">#</a></h3>
<p>The Mandiant article about the run command details a lot of details about what happens at the OS level. Since then the newer Managed Run Command has been released, which has has different host artifacts.</p>
<p> </p>
<p><strong>Old Action Run Command</strong></p>
<ul>
<li>Contains scripts at <code>/var/lib/waagent/run-command/download</code></li>
<li>Status/output of script at <code>/var/lib/waagent//Microsoft.CPlat.Core.RunCommandLinux-1.0.5/status</code></li>
<li>Full run logs <code>/var/log/azure/run-command/handler.log</code></li>
</ul>
<p>Windows: <code>C:\Packages\Plugins\Microsoft.CPlat.Core.RunCommandWindows\&lt;version number&gt;\Status\&lt;job number&gt;.status</code></p>
<p> </p>
<p><strong>New Managed Run Command</strong></p>
<ul>
<li>Contains scripts at <code>/var/lib/waagent/run-command-handler/download</code></li>
<li>Status/output of script at <code>/var/lib/waagent/Microsoft.CPlat.Core.RunCommandHandlerLinux-1.3.2/status</code></li>
<li>Full run logs <code>/var/log/azure/run-command-handler/handler.log</code></li>
</ul>
<p>Windows: <code>C:\Packages\Plugins\Microsoft.CPlat.Core.RunCommandHandlerWindows\&lt;version number&gt;\Status\&lt;job number&gt;.status</code></p>
<p> </p>
<p>As the Azure Activity Logs do not give any information about what was ran, these host artifacts are an important source of information, if there was no EDR or similar logging solution in place when the command was run.</p>
<p><img loading="lazy" src="status_file_ex.png" alt="echo &amp;quot;rawrX3&amp;quot;"  />

Example of a status output log doing <code>echo &quot;rawrX3</code>.</p>
<p>In the New Managed Run Command however, there is more information to collect.</p>
<p>Docs for the Managed Run Command: <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed">https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed</a></p>
<p>We can create a command via Az CLI</p>
<p><code>az vm run-command create --name &quot;mycustomRunCommand5&quot; --vm-name &quot;importantVM&quot; --resource-group &quot;VMSEC&quot; --script &quot;whoami&quot;</code>
<img loading="lazy" src="mgd-run-create.png" alt=""  />
</p>
<p>We can then list the created commands
<code>az vm run-command list --vm-name &quot;importantVM&quot; --resource-group &quot;VMSEC&quot;</code>
<img loading="lazy" src="mgd-run-list.png" alt=""  />
</p>
<p>The show command shows output of last execution in the &quot;output&quot; field.</p>
<p><img loading="lazy" src="mgd-run-show.png" alt=""  />
</p>
<p>Changing the script to run the &quot;date&quot; command shows that it does not trigger an execution of the script when you create it again, and the az vm run-command invoke command seems to only be part of the old Run commands. I cannot find a way to run one of the Managed Run commands with it.</p>
<p>These changes are logged in the Azure Activity logs, but not what is changed.
This means running</p>
<p><code>az vm run-command create --name &quot;mycustomRunCommand5&quot; --vm-name &quot;importantVM&quot; --resource-group &quot;VMSEC&quot; --script &quot;whoami&quot;</code></p>
<p>and then</p>
<p><code>az vm run-command create --name &quot;mycustomRunCommand5&quot; --vm-name &quot;importantVM&quot; --resource-group &quot;VMSEC&quot; --script &quot;echo 'owo'&quot;</code></p>
<p>Will only show the last &quot;echo 'owo'&quot; command, and not &quot;whoami&quot;.</p>
<p>From a forensics point of view you can then tell the last command that was run and its output, and correlate with the Azure Activity Logs to see if other scripts were run.</p>
<h3 id="forensics-evasion-via-secure-parameters">Forensics Evasion via Secure Parameters<a hidden class="anchor" aria-hidden="true" href="#forensics-evasion-via-secure-parameters">#</a></h3>
<p>The documentation for Managed Run Command shows that you can now pass parameters in a secure manner
<a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed#create-or-update-run-command-on-a-vm-instance-using-parameter-and-protectedparameter-parameters-public-and-protected-parameters-to-script">https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed#create-or-update-run-command-on-a-vm-instance-using-parameter-and-protectedparameter-parameters-public-and-protected-parameters-to-script</a></p>
<p>One part caught my eye.
<img loading="lazy" src="cmd-inject.png" alt=""  />
</p>
<p>These nameless params on linux seems like an easy place to place other commands in way that should evade some logging.</p>
<p>Creating our secure params</p>
<p><code>$ProtectedParametersArray = @([Microsoft.Azure.PowerShell.Cmdlets.Compute.Models.Api20210701.IRunCommandInputParameter]@{name='';value=';touch /owo69'})</code></p>
<p>Creating command</p>
<p><code>Set-AzVMRunCommand -ResourceGroupName VMSEC -VMName importantVM -RunCommandName SecretCommand -SourceScript &quot;hostname&quot; -ProtectedParameter $ProtectedParametersArray -Location EastUs</code></p>
<p>I ended up doing this in the cloud shell as for some reason I could not create the parameters without error locally.</p>
<p><img loading="lazy" src="no-sign-of-params.png" alt=""  />
</p>
<p>protectedParameters are shown as null, despite it very much being present.</p>
<p>Having run quite a few commands at this point there are a lot of file artifacts being dropped, but our secret command ran and created a file.</p>
<p><img loading="lazy" src="sneaky-owo.png" alt=""  />
</p>
<p>Looking at the logs from the Run commands shows no sign of any secret param</p>
<p><img loading="lazy" src="still-no-params.png" alt=""  />
</p>
<p>This means that the secret params can be used to run any command via Managed Run Commands without generating any logs.</p>
<p>Which is not great.</p>
<p> </p>
<p><strong>Azure Logs and KQL</strong></p>
<p><code>WRITE</code> is for creating the extensions.</p>
<p>This gives information about who created a new run command script, but not what it contains.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AzureActivity
</span></span><span class="line"><span class="cl">| where OperationNameValue == &#34;MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMANDS/WRITE&#34;
</span></span></code></pre></div><p> </p>
<p>Actually running the extensions are <code>MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION</code></p>
<p>This will show that A Run command was run, but not which one.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AzureActivity
</span></span><span class="line"><span class="cl">| where OperationNameValue == &#34;MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION&#34;
</span></span></code></pre></div><p>While doing this testing I found out that this did not seem to be case.</p>
<p>Creating a Managed Run Command also runs it, but this does not seem to show up in the logs as <code>MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION</code> OperationNameValue, only WRITE.</p>
<p><img loading="lazy" src="we-running-bois.png" alt=""  />

<img loading="lazy" src="write-run-os.png" alt=""  />
</p>
<p>I created a role with the notAction for <code>MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION</code> and only the <code>MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMANDS/WRITE</code> permission from MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMANDS</p>
<p>In theory, a user with only this role should only be able to write an Run Command, and not actually run it.
Turns out, no.</p>
<p><img loading="lazy" src="write-run-3.png" alt=""  />
</p>
<p><img loading="lazy" src="write-run-2.png" alt=""  />
</p>
<p> </p>
<p>I reported this MSRC and they have now documented this behaviour <a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed#limiting-access-to-run-command">https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command-managed#limiting-access-to-run-command</a>.</p>
<p> </p>
<p>This means that any detection rules based on detecting use of the ACTION will not detect use of the Managed Run Command.</p>
<p> </p>
<h2 id="defense">Defense<a hidden class="anchor" aria-hidden="true" href="#defense">#</a></h2>
<p>While the Run command is a useful feature it also has a very significant abuse potential for any compromised accounts with the right permissions.
Unfortunately the feature itself cannot be turned off, so it must be dealt with by managing permissions.</p>
<p>The first step is least privilege. Are you using this feature for admin work? Does everyone with permissions to use the Run Command need them?</p>
<p>If you are not using this feature, create custom roles to administer VMs that do not contain these permissions.</p>
<p>Generally your VM admins should use the Virtual Machine Contributor role rather than Owner or Contributor roles.
However, beware the documentation.
<img loading="lazy" src="VM-contrib-def.png" alt=""  />

If you look at this definition of the Virtual Machine Contributor, do you think that this role would be able to run commands on the VM?</p>
<p>Logging in to the portal with Virtual Machine Contributor role on a machine. What about now?
<img loading="lazy" src="portal-vm-contributor.png" alt=""  />
</p>
<p>You would probably think no, but you would be wrong.
It has the <code>Microsoft.Compute/virtualMachines/*</code> permissions, without associated notActions, and as such it can run commands.</p>
<p>In terms of Azure Security, be wary of what the Azure Portal says you cannot do, as it will lie to you. The API or Powershell is generally a better source of truth.</p>
<p>The docs do a better job at explaining what this role can actually do.
<a href="https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-contributor">https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-contributor</a></p>
<p><img loading="lazy" src="vm-contrib-docs.png" alt=""  />
</p>
<p>Creating a managed Run Command from an account with only the Virtual Machine Contributor role.</p>
<p> </p>
<p><img loading="lazy" src="vm-contrib-pwsh-run.png" alt=""  />
</p>
<p>And our file shows up</p>
<p> </p>
<p><img loading="lazy" src="VM-contrib_run-file.png" alt=""  />
</p>
<p> </p>
<p>To avoid this, we create a custom VM admin contributor role with notActions for the run command.</p>
<p><img loading="lazy" src="vm-contrib-not-actions.png" alt=""  />
</p>
<p>You can get this from my github.</p>
<p><a href="https://github.com/Soroganoth/Blog-Templates-and-Scripts/blob/main/Custom_Roles/Virtual%20Machine%20Contributor%20Without%20Run%20Command.bicep">Template</a></p>
<p>This is a clone of the Virtual Machine Contributor role, with the only changes being the notActions for the run command permissions. It is scoped be deployed at the subscription level.</p>
<p> </p>
<p>So now you have a role that can be used to do admin work, next step is enforcing that the normal Virtual Machine Contributor role is not used.</p>
<p> </p>
<p>Enter Azure Policy.</p>
<p>Microsoft has a boilerplate that be quickly modified to prevent using the role.</p>
<p><a href="https://github.com/Azure/azure-policy/blob/master/samples/Authorization/allowed-role-definitions/azurepolicy.json">https://github.com/Azure/azure-policy/blob/master/samples/Authorization/allowed-role-definitions/azurepolicy.json</a></p>
<p>Customizing to deny the Virtual Machine Contributor assignment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    &#34;mode&#34;: &#34;All&#34;,
</span></span><span class="line"><span class="cl">    &#34;policyRule&#34;: {
</span></span><span class="line"><span class="cl">      &#34;if&#34;: {
</span></span><span class="line"><span class="cl">        &#34;allOf&#34;: [
</span></span><span class="line"><span class="cl">          {
</span></span><span class="line"><span class="cl">            &#34;field&#34;: &#34;type&#34;,
</span></span><span class="line"><span class="cl">            &#34;equals&#34;: &#34;Microsoft.Authorization/roleAssignments&#34;
</span></span><span class="line"><span class="cl">          },
</span></span><span class="line"><span class="cl">          {
</span></span><span class="line"><span class="cl">            &#34;field&#34;: &#34;Microsoft.Authorization/roleAssignments/roleDefinitionId&#34;,
</span></span><span class="line"><span class="cl">            &#34;equals&#34;: &#34;/providers/Microsoft.Authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c&#34;
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">        ]
</span></span><span class="line"><span class="cl">      },
</span></span><span class="line"><span class="cl">      &#34;then&#34;: {
</span></span><span class="line"><span class="cl">        &#34;effect&#34;: &#34;deny&#34;
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    &#34;parameters&#34;: {}
</span></span><span class="line"><span class="cl">  }
</span></span></code></pre></div><p><a href="https://github.com/Soroganoth/Blog-Templates-and-Scripts/blob/main/Azure_Policy/No_VM_Contributor_roles.json">https://github.com/Soroganoth/Blog-Templates-and-Scripts/blob/main/Azure_Policy/No_VM_Contributor_roles.json</a></p>
<p>Paste this into the a new policy definition in the portal and deploy.</p>
<p>This will deny any attempts to assign the Virtual Machine Contributor role.</p>
<p> </p>
<p> </p>
<h2 id="end">End<a hidden class="anchor" aria-hidden="true" href="#end">#</a></h2>
<p>This is the first part of a planned series so stay tuned!</p>
<p> </p>
<p> </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://soroganoth.com/tags/azure-security/">Azure Security</a></li>
      <li><a href="https://soroganoth.com/tags/azure-vm-security/">Azure VM Security</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://soroganoth.com/post/shorts/api_call_for_graph_permissions/">
    <span class="title">Next »</span>
    <br>
    <span>Programmatically getting Microsoft Graph permissions</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command on twitter"
        href="https://twitter.com/intent/tweet/?text=Azure%20VM%20Security%3a%20Part%201%3a%20Moving%20from%20management%20plane%20to%20data%20plane%20and%20the%20Run%20Command&amp;url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f&amp;hashtags=AzureSecurity%2cAzureVMSecurity">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f&amp;title=Azure%20VM%20Security%3a%20Part%201%3a%20Moving%20from%20management%20plane%20to%20data%20plane%20and%20the%20Run%20Command&amp;summary=Azure%20VM%20Security%3a%20Part%201%3a%20Moving%20from%20management%20plane%20to%20data%20plane%20and%20the%20Run%20Command&amp;source=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f&title=Azure%20VM%20Security%3a%20Part%201%3a%20Moving%20from%20management%20plane%20to%20data%20plane%20and%20the%20Run%20Command">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command on whatsapp"
        href="https://api.whatsapp.com/send?text=Azure%20VM%20Security%3a%20Part%201%3a%20Moving%20from%20management%20plane%20to%20data%20plane%20and%20the%20Run%20Command%20-%20https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Azure VM Security: Part 1: Moving from management plane to data plane and the Run Command on telegram"
        href="https://telegram.me/share/url?text=Azure%20VM%20Security%3a%20Part%201%3a%20Moving%20from%20management%20plane%20to%20data%20plane%20and%20the%20Run%20Command&amp;url=https%3a%2f%2fsoroganoth.com%2fpost%2fresearch%2fazure_vm_security%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://soroganoth.com/">Soroganoth</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
